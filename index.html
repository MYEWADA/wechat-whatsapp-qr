class QRRedirector {
    constructor() {
        this.container = document.querySelector('.container');
        this.redirectTimer = null;
        this.currentLang = this.detectLanguage();
        this.initLanguageSwitcher();
        this.updateTexts();
        this.redirectAttempted = false;
    }

    // 增强版应用检测
    detectApp() {
        const ua = navigator.userAgent.toLowerCase();
        
        // 微信检测（包含桌面版）
        if (/micromessenger|wechat/i.test(ua)) {
            return {
                type: 'wechat',
                isDesktop: /windowswechat|macwechat/i.test(ua)
            };
        }
        
        // WhatsApp检测（包含Business和不同客户端）
        if (/(whatsapp|whatsapp business|wabusiness)/i.test(ua)) {
            return { 
                type: 'whatsapp',
                isBusiness: ua.includes('business')
            };
        }
        
        return null;
    }

    // 强化跳转逻辑
    async attemptRedirect(appInfo) {
        if (this.redirectAttempted) return;
        this.redirectAttempted = true;
        
        if (appInfo.type === 'wechat') {
            this.handleWeChatRedirect(appInfo);
        } else {
            await this.handleWhatsAppRedirect();
        }
    }

    // 微信跳转处理
    handleWeChatRedirect(appInfo) {
        if (appInfo.isDesktop) {
            this.showDesktopWeChatTip();
            return;
        }
        
        const redirectUrl = `weixin://dl/add?${CONFIG.wechatId}`;
        this.executeRedirect(redirectUrl, 'wechat');
    }

    // WhatsApp跳转处理（多级回退）
    async handleWhatsAppRedirect() {
        const phone = this.formatPhoneNumber(CONFIG.whatsappNumber);
        const redirectStrategies = [
            { url: `whatsapp://send?phone=${phone}`, type: 'native' },
            { url: `https://wa.me/${phone}`, type: 'wa.me', delay: 800 },
            { url: `https://api.whatsapp.com/send?phone=${phone}`, type: 'web', delay: 1800 }
        ];

        for (const strategy of redirectStrategies) {
            try {
                if (strategy.delay) {
                    await new Promise(resolve => setTimeout(resolve, strategy.delay));
                }
                
                if (!document.hidden) {
                    console.log(`Attempting ${strategy.type} redirect`);
                    this.executeRedirect(strategy.url, 'whatsapp');
                    
                    // 短暂等待确认跳转是否成功
                    await new Promise(resolve => setTimeout(resolve, 300));
                    if (document.hidden) return;
                }
            } catch (error) {
                console.error(`${strategy.type} redirect failed:`, error);
            }
        }
        
        this.showContactOptions();
    }

    // 执行跳转的核心方法
    executeRedirect(url, appType) {
        // 添加iframe作为备用跳转方式
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);
        
        // 主跳转方式
        window.location.href = url;
        
        // 3秒后清理iframe
        setTimeout(() => {
            document.body.removeChild(iframe);
        }, 3000);
    }

    // 电话号码格式化
    formatPhoneNumber(phone) {
        return phone.replace(/[^\d]/g, '').replace(/^(\d{2})(\d+)/, '$1$2');
    }

    // 显示桌面版微信提示
    showDesktopWeChatTip() {
        this.container.innerHTML = `
            <div class="option-card">
                <h3>${I18N[this.currentLang].wechat.title}</h3>
                <div class="desktop-tip">
                    ${I18N[this.currentLang].wechat.desktopTip}
                </div>
                <img src="${CONFIG.qrCodeUrls.wechat}" 
                     class="qr-code" 
                     alt="WeChat QR Code">
            </div>
        `;
    }

    // 其他方法保持不变...
}

// 初始化
document.addEventListener('DOMContentLoaded', () => {
    const qrRedirector = new QRRedirector();
    
    // 添加页面可见性变化的监听
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && qrRedirector.redirectTimer) {
            clearTimeout(qrRedirector.redirectTimer);
        }
    });
});
